<!DOCTYPE html>
<html>
<head>
    <title>{{if .IsOwnProfile}}My Profile{{else}}{{.User.Username}}'s Profile{{end}} - AirBnB Clone</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <div class="header">
        <a href="/" class="logo">AirBnBClone</a>
        
        <div class="auth-buttons">
            {{if .Auth.IsAuthenticated}}
                <a href="/my-profile" class="btn btn-login">My Profile</a>
                <a href="/logout" class="btn btn-signup">Logout</a>
            {{else}}
                <a href="/login" class="btn btn-login">Login</a>
                <a href="/register" class="btn btn-signup">Sign Up</a>
            {{end}}
        </div>
    </div>

    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar">
                <div class="avatar-placeholder">
                    {{if .User.FirstName}}{{slice .User.FirstName 0 1}}{{else}}{{slice .User.Username 0 1}}{{end}}
                </div>
            </div>
            <div class="profile-info">
                <h1>{{if .User.FirstName}}{{.User.FirstName}} {{.User.LastName}}{{else}}{{.User.Username}}{{end}}</h1>
                <p class="username">@{{.User.Username}}</p>
                <p class="role">{{.User.Role}}</p>
                <p class="member-since">Member since {{.User.CreatedAt}}</p>
            </div>
        </div>

        <div class="profile-content">
            {{if .IsOwnProfile}}
                <div class="profile-section">
                    <h2>My Account</h2>
                    <div class="account-info">
                        <div class="info-item">
                            <label>Email:</label>
                            <span>{{.User.Email}}</span>
                        </div>
                        <div class="info-item">
                            <label>Phone:</label>
                            <span>{{.User.PhoneNumber}}</span>
                        </div>
                        <div class="info-item">
                            <label>User ID:</label>
                            <span>{{.User.ID}}</span>
                        </div>
                    </div>
                    <div class="profile-actions">
                        <a href="/edit-profile" class="btn btn-edit">Edit Profile</a>
                        <button class="btn btn-settings">Settings</button>
                    </div>
                </div>
            {{else}}
                <div class="profile-section">
                    <h2>About {{.User.Username}}</h2>
                    <p>This is {{.User.Username}}'s profile page.</p>
                    <p>Member since {{.User.CreatedAt}}</p>
                </div>
            {{end}}

            {{if .IsOwnProfile}}
                <!-- Reviews to Write Section -->
                {{if .ReviewableBookings}}
                <div class="profile-section">
                    <h2>üåü Write Reviews</h2>
                    <p>Your host has enabled you to review these properties:</p>
                    
                    <div class="reviewable-bookings">
                        {{range .ReviewableBookings}}
                        <div class="reviewable-card">
                            <div class="booking-header">
                                <h3>{{.PropertyTitle}}</h3>
                                {{if eq .Status "can_review"}}
                                    <span class="booking-status can-review">Can Review</span>
                                {{else}}
                                    <span class="booking-status reviewed">Reviewed</span>
                                {{end}}
                            </div>
                            <div class="booking-details">
                                <div class="booking-info">
                                    <span class="booking-label">Location:</span>
                                    <span>{{.PropertyCity}}</span>
                                </div>
                                <div class="booking-info">
                                    <span class="booking-label">Stay Dates:</span>
                                    <span>{{.StartDate}} - {{.EndDate}}</span>
                                </div>
                            </div>
                            {{if eq .Status "can_review"}}
                                <div class="booking-actions">
                                    <button class="btn btn-review" onclick="openReviewModal('{{.PostID}}', '{{.ID}}', '{{.PropertyTitle}}')">
                                        Write Review
                                    </button>
                                    <a href="/property/{{.PostID}}" class="btn btn-view">View Property</a>
                                </div>
                            {{else}}
                                <div class="booking-actions">
                                    <span class="review-done">‚úì Review submitted</span>
                                    <a href="/property/{{.PostID}}" class="btn btn-view">View Property</a>
                                </div>
                            {{end}}
                        </div>
                        {{end}}
                    </div>
                </div>
                {{end}}

                <div class="profile-section">
                    <h2>My Bookings</h2>
                    
                    {{if .UserBookings}}
                        <div class="bookings-grid">
                            {{range .UserBookings}}
                            <div class="booking-card">
                                <div class="booking-header">
                                    <h3>{{.PropertyTitle}}</h3>
                                    <span class="booking-status confirmed">Confirmed</span>
                                </div>
                                <div class="booking-details">
                                    <div class="booking-info">
                                        <span class="booking-label">Location:</span>
                                        <span>{{.PropertyCity}}</span>
                                    </div>
                                    <div class="booking-info">
                                        <span class="booking-label">Dates:</span>
                                        <span>{{.StartDate}} - {{.EndDate}}</span>
                                    </div>
                                    <div class="booking-info">
                                        <span class="booking-label">Guests:</span>
                                        <span>{{.Guests}}</span>
                                    </div>
                                    <div class="booking-info total">
                                        <span class="booking-label">Total:</span>
                                        <span class="booking-price">${{printf "%.2f" .TotalPrice}}</span>
                                    </div>
                                </div>
                                <div class="booking-actions">
                                    <a href="/property/{{.PostID}}" class="btn btn-view">View Property</a>
                                </div>
                            </div>
                            {{end}}
                        </div>
                    {{else}}
                        <div class="no-bookings">
                            <p>You haven't made any bookings yet.</p>
                            <a href="/explore" class="btn btn-create">Start Exploring</a>
                        </div>
                    {{end}}
                </div>

                {{if .HostBookings}}
                <div class="profile-section">
                    <h2>Manage Guest Reviews</h2>
                    <p>Allow your guests to leave reviews for their stays:</p>
                    
                    <div class="bookings-grid">
                        {{range .HostBookings}}
                        <div class="booking-card host-booking">
                            <div class="booking-header">
                                <h3>{{.PropertyTitle}}</h3>
                                {{if eq .Status "review_enabled"}}
                                    <span class="booking-status review-enabled">Review Enabled</span>
                                {{else}}
                                    <span class="booking-status completed">Completed</span>
                                {{end}}
                            </div>
                            <div class="booking-details">
                                <div class="booking-info">
                                    <span class="booking-label">Guest:</span>
                                    <span>{{.UserName}}</span>
                                </div>
                                <div class="booking-info">
                                    <span class="booking-label">Dates:</span>
                                    <span>{{.StartDate}} - {{.EndDate}}</span>
                                </div>
                                <div class="booking-info">
                                    <span class="booking-label">Guests:</span>
                                    <span>{{.Guests}}</span>
                                </div>
                                <div class="booking-info total">
                                    <span class="booking-label">Earnings:</span>
                                    <span class="booking-price">${{printf "%.2f" .TotalPrice}}</span>
                                </div>
                            </div>
                            <div class="booking-actions">
                                {{if eq .Status "completed"}}
                                    <button class="btn btn-enable-review" onclick="enableReview('{{.ID}}', '{{.UserName}}', '{{.PropertyTitle}}')">
                                        Enable Review
                                    </button>
                                {{else}}
                                    <span class="review-enabled-text">‚úì Guest can review</span>
                                {{end}}
                                <a href="/property/{{.PostID}}" class="btn btn-view">View Property</a>
                            </div>
                        </div>
                        {{end}}
                    </div>
                </div>
                {{end}}
            {{end}}

            <div class="profile-section">
                <div class="listings-header">
                    <h2>
                        {{if .IsAdmin}}All Listings (Admin View){{else if .IsOwnProfile}}My Listings{{else}}Listings{{end}}
                    </h2>
                    
                    {{if .IsOwnProfile}}
                    <div class="listings-actions">
                        <a href="/add-listing" class="btn btn-create-listing">
                            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 2a.75.75 0 01.75.75v6.5h6.5a.75.75 0 010 1.5h-6.5v6.5a.75.75 0 01-1.5 0v-6.5h-6.5a.75.75 0 010-1.5h6.5v-6.5A.75.75 0 0110 2z"/>
                            </svg>
                            Add New Listing
                        </a>
                    </div>
                    {{end}}
                </div>
                
                {{if .Listings}}
                    <div class="listings-grid">
                        {{range .Listings}}
                        <div class="listing-card" onclick="window.location.href='/property/{{.ID}}'">
                            <div class="listing-image">
                                {{if .ImageURL}}
                                <img src="{{.ImageURL}}" alt="{{.Title}}" loading="lazy">
                                {{else}}
                                <div class="image-placeholder">
                                    <svg width="48" height="48" viewBox="0 0 48 48" fill="none">
                                        <path d="M40 12H8c-2.21 0-4 1.79-4 4v16c0 2.21 1.79 4 4 4h32c2.21 0 4-1.79 4-4V16c0-2.21-1.79-4-4-4zM8 16h32v16H8V16zm8 12l5-6 5 6 7-8 7 8H16z" fill="#ccc"/>
                                    </svg>
                                </div>
                                {{end}}
                                
                                {{if $.IsOwnProfile}}
                                    <a href="/edit-listing/{{.ID}}" class="listing-edit-btn" onclick="event.stopPropagation();">
                                        <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                                            <path d="M8.5 1c-.5 0-1 .2-1.4.6L2 6.7v2.8h2.8l5.1-5.1c.8-.8.8-2 0-2.8L8.5 1zM7.8 2.4L9.6 4.2 4.2 9.5H2.5V7.8l5.3-5.4z"/>
                                        </svg>
                                        Edit
                                    </a>
                                {{end}}
                                
                                <button class="wishlist-btn" onclick="event.stopPropagation(); toggleWishlist('{{.ID}}')">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                                    </svg>
                                </button>
                            </div>
                            
                            <div class="listing-info">
                                <div class="listing-location">
                                    <h3>{{.City}}, {{.Country}}</h3>
                                    <p class="listing-title">{{.Title}}</p>
                                </div>
                                
                                <div class="listing-details">
                                    <span class="property-type">{{.Type}}</span>
                                    {{if .HasWifi}}<span class="amenity-tag">WiFi</span>{{end}}
                                    {{if .HasKitchen}}<span class="amenity-tag">Kitchen</span>{{end}}
                                    {{if .HasAC}}<span class="amenity-tag">AC</span>{{end}}
                                    {{if .HasParking}}<span class="amenity-tag">Parking</span>{{end}}
                                </div>
                                
                                <div class="listing-price">
                                    <span class="price">${{printf "%.0f" .Price}}</span>
                                    <span class="per-night">per night</span>
                                </div>
                                
                                {{if $.IsAdmin}}
                                <div class="listing-owner">
                                    <small>Owner ID: {{.UserID}}</small>
                                </div>
                                {{end}}
                            </div>
                        </div>
                        {{end}}
                    </div>
                {{else}}
                    <div class="no-listings">
                        <div class="no-listings-content">
                            <svg width="64" height="64" viewBox="0 0 64 64" fill="none">
                                <path d="M32 8C18.7 8 8 18.7 8 32s10.7 24 24 24 24-10.7 24-24S45.3 8 32 8zm12 26H34v10h-4V34H20v-4h10V20h4v10h10v4z" fill="#ddd"/>
                            </svg>
                            <h3>
                                {{if .IsAdmin}}
                                    No listings found in the system.
                                {{else if .IsOwnProfile}}
                                    Start hosting today!
                                {{else}}
                                    No listings available.
                                {{end}}
                            </h3>
                            <p>
                                {{if .IsOwnProfile}}
                                    Share your space and earn money by hosting travelers from around the world.
                                {{end}}
                            </p>
                            {{if .IsOwnProfile}}
                                <a href="/add-listing" class="btn btn-create-listing">Create Your First Listing</a>
                            {{end}}
                        </div>
                    </div>
                {{end}}
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="review-modal-overlay" style="display: none;">
        <div class="review-modal-dialog">
            <div class="review-modal-content">
                <div class="review-modal-header">
                    <h2>Write a Review</h2>
                    <button type="button" class="review-modal-close" onclick="closeReviewModal()">&times;</button>
                </div>
                <div class="review-modal-body">
                    <h3 id="reviewPropertyTitle"></h3>
                    <form id="reviewForm">
                        <input type="hidden" id="reviewPropertyId" name="property_id">
                        <input type="hidden" id="reviewBookingId" name="booking_id">
                        
                        <div class="rating-section">
                            <label>Rating:</label>
                            <div class="star-rating">
                                <input type="radio" name="rating" value="5" id="star5">
                                <label for="star5">‚≠ê</label>
                                <input type="radio" name="rating" value="4" id="star4">
                                <label for="star4">‚≠ê</label>
                                <input type="radio" name="rating" value="3" id="star3">
                                <label for="star3">‚≠ê</label>
                                <input type="radio" name="rating" value="2" id="star2">
                                <label for="star2">‚≠ê</label>
                                <input type="radio" name="rating" value="1" id="star1">
                                <label for="star1">‚≠ê</label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="reviewComment">Your Review:</label>
                            <textarea id="reviewComment" name="comment" rows="4" placeholder="Share your experience..." required></textarea>
                        </div>
                        
                        <div class="review-modal-actions">
                            <button type="submit" class="btn btn-create">Submit Review</button>
                            <button type="button" class="btn btn-cancel" onclick="closeReviewModal()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        function toggleWishlist(propertyId) {
            console.log('Toggle wishlist for property:', propertyId);
        }

        function openReviewModal(propertyId, bookingId, propertyTitle) {
            document.getElementById('reviewPropertyId').value = propertyId;
            document.getElementById('reviewBookingId').value = bookingId;
            document.getElementById('reviewPropertyTitle').textContent = propertyTitle;
            document.getElementById('reviewModal').style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
            document.getElementById('reviewForm').reset();
            document.body.style.overflow = 'auto';
        }

        function enableReview(bookingId, guestName, propertyTitle) {
            if (confirm(`Allow ${guestName} to review "${propertyTitle}"?`)) {
                fetch('/enable-review', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `booking_id=${bookingId}`
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Error enabling review');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error enabling review');
                });
            }
        }

        // Submit review form
        document.getElementById('reviewForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const data = new URLSearchParams(formData);
            
            fetch('/submit-review', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: data
            })
            .then(response => {
                if (response.ok) {
                    closeReviewModal();
                    location.reload();
                } else {
                    alert('Error submitting review');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error submitting review');
            });
        });

        // Star rating functionality
        const stars = document.querySelectorAll('.star-rating input');
        stars.forEach((star, index) => {
            star.addEventListener('change', function() {
                console.log('Rating selected:', this.value);
            });
        });

        document.getElementById('reviewModal').addEventListener('click', function(event) {
            if (event.target === this) {
                closeReviewModal();
            }
        });
    </script>
</body>
</html>